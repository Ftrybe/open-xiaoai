<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°çˆ±éŸ³ç®±è‡ªå®šä¹‰æ¶ˆæ¯ç®¡ç†</title>
    <link href="./tailwind.css" rel="stylesheet">
    <style>
        /* è‡ªå®šä¹‰åŠ¨ç”»å’Œç‰¹æ®Šæ ·å¼ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal {
            animation: fadeIn 0.3s;
        }
        
        .modal-content {
            animation: slideIn 0.3s;
        }
        
        .rule-type.text { background-color: #10b981; }
        .rule-type.audio { background-color: #3b82f6; }
        .rule-type.localCode { background-color: #f59e0b; }
        .rule-type.sandboxCode { background-color: #8b5cf6; }
        .rule-type.terminalCommand { background-color: #ef4444; }
        .rule-type.apiCall { background-color: #f97316; }
        .rule-type.pythonRemote { background-color: #14b8a6; }
        .rule-type.nodeRemote { background-color: #06b6d4; }
    </style>
</head>
<body class="font-sans text-gray-800 bg-gray-100">
    <div class="p-5 mx-auto max-w-7xl">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="p-8 mb-8 text-center text-white shadow-lg bg-gradient-to-r from-primary-500 to-purple-600 rounded-xl">
            <h1 class="mb-2 text-3xl font-bold">ğŸµ å°çˆ±éŸ³ç®±è‡ªå®šä¹‰æ¶ˆæ¯ç®¡ç†</h1>
            <p class="text-lg opacity-90">è½»æ¾ç®¡ç†ä½ çš„å°çˆ±éŸ³ç®±è‡ªå®šä¹‰å›å¤è§„åˆ™</p>
        </div>
        
        <!-- çŠ¶æ€æç¤º -->
        <div id="status" class="hidden p-4 mb-6 transition-all duration-300 rounded-lg"></div>
        
        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <div class="flex mb-6 overflow-hidden bg-white rounded-lg shadow-sm">
            <div class="flex-1 p-4 font-semibold text-center border-b-2 cursor-pointer border-primary-500 text-primary-500 tab active" onclick="switchTab('rules')">
                æ¶ˆæ¯è§„åˆ™ç®¡ç†
            </div>
            <div class="flex-1 p-4 text-center text-gray-500 border-b-2 border-transparent cursor-pointer hover:text-gray-700 tab" onclick="switchTab('settings')">
                å…¨å±€è®¾ç½®
            </div>
        </div>
        
        <!-- æ¶ˆæ¯è§„åˆ™ç®¡ç† -->
        <div id="rules-tab" class="tab-content active">
            <div class="p-6 bg-white shadow-lg rounded-xl">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">å½“å‰æ¶ˆæ¯è§„åˆ™</h2>
                    <div class="space-x-3">
                        <button onclick="addNewRule()" class="px-4 py-2 font-medium text-white transition-colors duration-200 bg-green-500 rounded-lg hover:bg-green-600">
                            â• æ–°å¢è§„åˆ™
                        </button>
                        <button onclick="loadRules()" class="px-4 py-2 font-medium text-white transition-colors duration-200 bg-gray-500 rounded-lg hover:bg-gray-600">
                            ğŸ”„ åˆ·æ–°è§„åˆ™
                        </button>
                    </div>
                </div>
                
                <!-- æœç´¢æ¡† -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <div class="relative flex-1 max-w-md">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <input type="text" id="search-input" placeholder="æœç´¢è§„åˆ™ï¼ˆå…³é”®è¯ã€æè¿°æˆ–å“åº”ç±»å‹ï¼‰" 
                                   class="w-full py-2 pl-10 pr-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                   oninput="filterRules()">
                        </div>
                        <div class="ml-4 text-sm text-gray-600">
                            <span id="rules-count">æ€»å…± 0 æ¡è§„åˆ™</span>
                        </div>
                    </div>
                </div>
                
                <div id="rules-list" class="space-y-4">
                    <!-- è§„åˆ™åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <!-- å…¨å±€è®¾ç½® -->
        <div id="settings-tab" class="hidden tab-content">
            <div class="p-6 bg-white shadow-lg rounded-xl">
                <h2 class="mb-6 text-2xl font-bold text-gray-800">å…¨å±€è®¾ç½®</h2>
                <form id="settings-form" class="space-y-6">
                    <div>
                        <label for="call-keywords" class="block mb-2 text-sm font-medium text-gray-700">AI å”¤é†’å…³é”®è¯</label>
                        <input type="text" id="call-keywords" name="callKeywords" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                               placeholder="è¯·,ä½ " value="è¯·,ä½ ">
                        <p class="mt-1 text-sm text-gray-500">ç”¨è‹±æ–‡é€—å·åˆ†éš”å¤šä¸ªå…³é”®è¯</p>
                    </div>
                    <div>
                        <label for="system-prompt" class="block mb-2 text-sm font-medium text-gray-700">ç³»ç»Ÿæç¤ºè¯</label>
                        <textarea id="system-prompt" name="systemPrompt" rows="4"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                  placeholder="ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹...">ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ï¼Œè¯·æ ¹æ®ç”¨æˆ·çš„é—®é¢˜ç»™å‡ºå›ç­”ã€‚</textarea>
                    </div>
                    <div>
                        <label for="history-max-length" class="block mb-2 text-sm font-medium text-gray-700">å†å²æ¶ˆæ¯æœ€å¤§æ•°é‡</label>
                        <input type="number" id="history-max-length" name="historyMaxLength" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                               value="10" min="0" max="50">
                    </div>
                    
                    <!-- OpenAI é…ç½® -->
                    <fieldset class="p-4 border border-gray-300 rounded-lg">
                        <legend class="px-2 text-sm font-semibold text-primary-600">ğŸ¤– OpenAI é…ç½®</legend>
                        <div class="space-y-4">
                          
                            <div>
                                <label for="openai-base-url" class="block mb-2 text-sm font-medium text-gray-700">Base URL</label>
                                <input type="url" id="openai-base-url" name="openaiBaseUrl" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                       placeholder="https://api.openai.com/v1">
                            </div>
                            <div>
                                <label for="openai-model" class="block mb-2 text-sm font-medium text-gray-700">æ¨¡å‹</label>
                                <input type="text" id="openai-model" name="openaiModel" list="model-suggestions"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                       placeholder="è¾“å…¥æ¨¡å‹åç§°ï¼Œå¦‚ï¼šgpt-4o">
                                <datalist id="model-suggestions">
                                    <option value="gpt-3.5-turbo">
                                    <option value="gpt-4">
                                    <option value="gpt-4-turbo">
                                    <option value="gpt-4o">
                                    <option value="gpt-4o-mini">
                                    <option value="claude-3-opus">
                                    <option value="claude-3-sonnet">
                                    <option value="claude-3-haiku">
                                    <option value="claude-4">
                                    <option value="deepseek-chat">
                                    <option value="qwen-turbo">
                                </datalist>
                            </div>

                              <div>
                                <label for="openai-api-key" class="block mb-2 text-sm font-medium text-gray-700">API Key</label>
                                <input  id="openai-api-key" name="openaiApiKey" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                       placeholder="api key">
                            </div>
                        </div>
                    </fieldset>
                    <div class="flex space-x-4">
                        <button type="submit" class="px-6 py-2 font-medium text-white transition-colors duration-200 bg-green-500 rounded-lg hover:bg-green-600">
                            ğŸ’¾ ä¿å­˜è®¾ç½®
                        </button>
                        <button type="button" onclick="loadSettings()" class="px-6 py-2 font-medium text-white transition-colors duration-200 bg-gray-500 rounded-lg hover:bg-gray-600">
                            ğŸ”„ é‡æ–°åŠ è½½
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- ç¼–è¾‘è§„åˆ™æ¨¡æ€æ¡† -->
        <div id="edit-modal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="w-full max-w-4xl max-h-screen overflow-y-auto bg-white shadow-2xl rounded-xl modal-content">
                    <div class="p-6 text-white bg-gradient-to-r from-primary-500 to-purple-600 rounded-t-xl">
                        <div class="flex items-center justify-between">
                            <h3 class="text-xl font-bold">ğŸ“ ç¼–è¾‘æ¶ˆæ¯è§„åˆ™</h3>
                            <button onclick="closeEditModal()" class="p-2 text-white transition-colors duration-200 rounded-full hover:bg-white hover:bg-opacity-20">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <form id="edit-rule-form" class="space-y-6">
                            <input type="hidden" id="edit-rule-id" name="ruleId">
                            
                            <div>
                                <label for="edit-description" class="block mb-2 text-sm font-medium text-gray-700">è§„åˆ™æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                                <input type="text" id="edit-description" name="description" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                       placeholder="è§„åˆ™æè¿°">
                            </div>
                            
                            <!-- è§¦å‘æ¡ä»¶é…ç½® -->
                            <fieldset class="p-4 border border-gray-300 rounded-lg">
                                <legend class="px-2 text-sm font-semibold text-primary-600">ğŸ¯ è§¦å‘æ¡ä»¶</legend>
                                <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                                    <div>
                                        <label for="edit-trigger-type" class="block mb-2 text-sm font-medium text-gray-700">åŒ¹é…æ–¹å¼</label>
                                        <select id="edit-trigger-type" name="triggerType" 
                                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                            <option value="exact">ç²¾ç¡®åŒ¹é…</option>
                                            <option value="startsWith">ä»¥...å¼€å§‹</option>
                                            <option value="contains">åŒ…å«</option>
                                            <option value="endsWith">ä»¥...ç»“æŸ</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="edit-keyword" class="block mb-2 text-sm font-medium text-gray-700">å…³é”®è¯</label>
                                        <input type="text" id="edit-keyword" name="keyword" 
                                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                               placeholder="ä¾‹å¦‚ï¼šæµ‹è¯•æ’­æ”¾æ–‡å­—" required>
                                    </div>
                                </div>
                            </fieldset>
                            
                            <!-- å“åº”é…ç½® -->
                            <fieldset class="p-4 border border-gray-300 rounded-lg">
                                <legend class="px-2 text-sm font-semibold text-primary-600">ğŸ¬ å“åº”é…ç½®</legend>
                                <div class="mb-4">
                                    <label for="edit-response-type" class="block mb-2 text-sm font-medium text-gray-700">å“åº”ç±»å‹</label>
                                    <select id="edit-response-type" name="responseType" onchange="updateEditResponseFields()"
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                        <option value="text">æ–‡å­—å›å¤</option>
                                        <option value="audio">éŸ³é¢‘æ’­æ”¾</option>
                                        <option value="builtInCommand">å†…ç½®æŒ‡ä»¤</option>
                                        <option value="localCode">æœ¬åœ°ä»£ç æ‰§è¡Œ</option>
                                        <option value="sandboxCode">æ²™ç›’ä»£ç æ‰§è¡Œ</option>
                                        <option value="terminalCommand">ç»ˆç«¯å‘½ä»¤æ‰§è¡Œ</option>
                                        <option value="apiCall">APIæ¥å£è°ƒç”¨</option>
                                        <option value="pythonRemote">Pythonè¿œç¨‹æ‰§è¡Œ</option>
                                        <option value="nodeRemote">Node.jsè¿œç¨‹æ‰§è¡Œ</option>
                                    </select>
                                </div>
                                
                                <!-- åŠ¨æ€å“åº”å­—æ®µ -->
                                <div id="edit-response-fields" class="space-y-4">
                                    <!-- å­—æ®µä¼šé€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </fieldset>
                            
                            <div>
                                <label for="edit-enabled" class="block mb-2 text-sm font-medium text-gray-700">å¯ç”¨çŠ¶æ€</label>
                                <select id="edit-enabled" name="enabled" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                    <option value="true">å¯ç”¨</option>
                                    <option value="false">ç¦ç”¨</option>
                                </select>
                            </div>
                            
                            <div class="flex justify-end pt-4 space-x-4 border-t border-gray-200">
                                <button type="button" onclick="closeEditModal()" 
                                        class="px-6 py-2 font-medium text-white transition-colors duration-200 bg-gray-500 rounded-lg hover:bg-gray-600">
                                    âŒ å–æ¶ˆ
                                </button>
                                <button type="submit" 
                                        class="px-6 py-2 font-medium text-white transition-colors duration-200 bg-green-500 rounded-lg hover:bg-green-600">
                                    ğŸ’¾ ä¿å­˜æ›´æ”¹
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å½“å‰æ¿€æ´»çš„æ ‡ç­¾é¡µ
        let activeTab = 'rules';
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active', 'border-primary-500', 'text-primary-500', 'font-semibold');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
                content.classList.remove('active');
            });
            
            // è®¾ç½®æ–°çš„æ¿€æ´»çŠ¶æ€
            const activeTabEl = document.querySelector(`.tab:nth-child(${tabName === 'rules' ? 1 : 2})`);
            activeTabEl.classList.add('active', 'border-primary-500', 'text-primary-500', 'font-semibold');
            activeTabEl.classList.remove('border-transparent', 'text-gray-500');
            
            const activeContentEl = document.getElementById(`${tabName}-tab`);
            activeContentEl.classList.remove('hidden');
            activeContentEl.classList.add('active');
            
            activeTab = tabName;
            
            // å¦‚æœåˆ‡æ¢åˆ°è§„åˆ™ç®¡ç†é¡µé¢ï¼Œè‡ªåŠ¨åŠ è½½è§„åˆ™
            if (tabName === 'rules') {
                loadRules();
            } else if (tabName === 'settings') {
                loadSettings();
            }
        }
        
        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'success') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `p-4 rounded-lg mb-6 transition-all duration-300 ${
                type === 'success' 
                    ? 'bg-green-100 text-green-800 border border-green-300' 
                    : 'bg-red-100 text-red-800 border border-red-300'
            }`;
            statusEl.classList.remove('hidden');
            
            setTimeout(() => {
                statusEl.classList.add('hidden');
            }, 3000);
        }
        
        // å…¨å±€å˜é‡å­˜å‚¨æ‰€æœ‰è§„åˆ™
        let allRules = [];
        
        // åŠ è½½æ¶ˆæ¯è§„åˆ™
        async function loadRules() {
            try {
                const response = await fetch('/api/rules');
                const rules = await response.json();
                allRules = rules;
                
                displayRules(rules);
            } catch (error) {
                showStatus('åŠ è½½è§„åˆ™å¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
        // æ˜¾ç¤ºè§„åˆ™åˆ—è¡¨
        function displayRules(rules) {
            const rulesList = document.getElementById('rules-list');
            const rulesCount = document.getElementById('rules-count');
            
            if (rules.length === 0) {
                rulesList.innerHTML = '<p class="py-12 text-center text-gray-500">æš‚æ— è‡ªå®šä¹‰è§„åˆ™</p>';
                rulesCount.textContent = 'æ€»å…± 0 æ¡è§„åˆ™';
                return;
            }
            
            // æ›´æ–°è®¡æ•°
            const searchTerm = document.getElementById('search-input').value.trim();
            if (searchTerm) {
                rulesCount.textContent = `æ‰¾åˆ° ${rules.length} æ¡è§„åˆ™ (æ€»å…± ${allRules.length} æ¡)`;
            } else {
                rulesCount.textContent = `æ€»å…± ${rules.length} æ¡è§„åˆ™`;
            }
            
            rulesList.innerHTML = rules.map(rule => `
                <div class="p-4 transition-shadow duration-200 border border-gray-200 rounded-lg bg-gray-50 hover:shadow-md">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center mb-2 space-x-3">
                                <span class="text-lg font-semibold text-gray-900">"${rule.trigger.keyword}"</span>
                                <span class="rule-type ${rule.response.type} text-white text-xs px-2 py-1 rounded font-medium">
                                    ${getRuleTypeText(rule.response.type)}
                                </span>
                                <span class="px-2 py-1 text-xs text-gray-700 bg-gray-200 rounded">
                                    ${getTriggerTypeText(rule.trigger.type)}
                                </span>
                                ${!rule.enabled ? '<span class="px-2 py-1 text-xs text-red-700 bg-red-100 rounded">å·²ç¦ç”¨</span>' : '<span class="px-2 py-1 text-xs text-green-700 bg-green-100 rounded">å·²å¯ç”¨</span>'}
                            </div>
                            <div class="pl-2 text-sm text-gray-600">
                                ${rule.description || 'æ— æè¿°'}
                            </div>
                        </div>
                        <div class="flex ml-4 space-x-2">
                            <button onclick="editRule('${rule.id}')" 
                                    class="px-3 py-1 text-sm text-white transition-colors duration-200 bg-blue-500 rounded hover:bg-blue-600">
                                âœï¸ ç¼–è¾‘
                            </button>
                            <button onclick="deleteRule('${rule.id}')" 
                                    class="px-3 py-1 text-sm text-white transition-colors duration-200 bg-red-500 rounded hover:bg-red-600">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // æœç´¢è¿‡æ»¤è§„åˆ™
        function filterRules() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            if (!searchTerm.trim()) {
                displayRules(allRules);
                return;
            }
            
            const filteredRules = allRules.filter(rule => {
                const keyword = rule.trigger.keyword.toLowerCase();
                const description = (rule.description || '').toLowerCase();
                const responseType = getRuleTypeText(rule.response.type).toLowerCase();
                const triggerType = getTriggerTypeText(rule.trigger.type).toLowerCase();
                
                return keyword.includes(searchTerm) ||
                       description.includes(searchTerm) ||
                       responseType.includes(searchTerm) ||
                       triggerType.includes(searchTerm);
            });
            
            displayRules(filteredRules);
        }
        
        // è·å–è§„åˆ™ç±»å‹æ–‡æœ¬
        function getRuleTypeText(type) {
            const typeMap = {
                'text': 'æ–‡å­—',
                'audio': 'éŸ³é¢‘', 
                'builtInCommand': 'å†…ç½®æŒ‡ä»¤',
                'localCode': 'æœ¬åœ°ä»£ç ',
                'sandboxCode': 'æ²™ç›’ä»£ç ',
                'terminalCommand': 'ç»ˆç«¯å‘½ä»¤',
                'apiCall': 'APIè°ƒç”¨',
                'pythonRemote': 'Pythonè¿œç¨‹',
                'nodeRemote': 'Nodeè¿œç¨‹'
            };
            return typeMap[type] || type;
        }
        
        // è·å–è§¦å‘ç±»å‹æ–‡æœ¬
        function getTriggerTypeText(type) {
            const typeMap = {
                'exact': 'ç²¾ç¡®åŒ¹é…',
                'startsWith': 'å¼€å§‹äº',
                'contains': 'åŒ…å«',
                'endsWith': 'ç»“æŸäº'
            };
            return typeMap[type] || type;
        }
        
        // æ ¼å¼åŒ–è§„åˆ™å†…å®¹
        function formatRuleContent(rule) {
            const response = rule.response;
            switch (response.type) {
                case 'text':
                    return `å›å¤æ–‡å­—ï¼š${response.text}`;
                case 'audio':
                    return `éŸ³é¢‘é“¾æ¥ï¼š${response.audioUrl}${response.audioText ? `<br>æ’­æ”¾å‰æ–‡å­—ï¼š${response.audioText}` : ''}`;
                case 'builtInCommand':
                    return `å†…ç½®æŒ‡ä»¤ï¼š${response.builtInCommand}`;
                case 'localCode':
                    return `æœ¬åœ°ä»£ç ï¼š<br><pre class="p-2 mt-2 overflow-x-auto text-sm bg-gray-100 rounded">${response.localCode}</pre>`;
                case 'sandboxCode':
                    return `æ²™ç›’ä»£ç ï¼š<br><pre class="p-2 mt-2 overflow-x-auto text-sm bg-gray-100 rounded">${response.sandboxCode}</pre>`;
                case 'terminalCommand':
                    let terminalInfo = `ç»ˆç«¯å‘½ä»¤ï¼š<code class="px-2 py-1 bg-gray-100 rounded">${response.terminalCommand}</code><br>`;
                    
                    if (response.ssh) {
                        terminalInfo += `<span class="text-blue-600">ğŸ” SSHè¿œç¨‹æ‰§è¡Œ</span><br>`;
                        terminalInfo += `ä¸»æœº: ${response.ssh.host}:${response.ssh.port}<br>`;
                        terminalInfo += `ç”¨æˆ·: ${response.ssh.username}<br>`;
                        terminalInfo += `è®¤è¯: ${response.ssh.authMethod === 'key' ? 'å¯†é’¥è®¤è¯' : 'å¯†ç è®¤è¯'}<br>`;
                        if (response.ssh.authMethod === 'key' && response.ssh.privateKeyPath) {
                            terminalInfo += `ç§é’¥: ${response.ssh.privateKeyPath}<br>`;
                        }
                    } else {
                        terminalInfo += `<span class="text-gray-600">ğŸ’» æœ¬åœ°æ‰§è¡Œ</span><br>`;
                    }
                    
                    terminalInfo += `å·¥ä½œç›®å½•: ${response.terminalWorkingDir || 'å½“å‰ç›®å½•'}<br>`;
                    terminalInfo += `è¶…æ—¶: ${response.terminalTimeout || 30}ç§’ | è¿”å›è¾“å‡º: ${response.terminalReturnOutput !== false ? 'æ˜¯' : 'å¦'}`;
                    
                    return terminalInfo;
                case 'apiCall':
                    let apiInfo = `APIè°ƒç”¨ï¼š${response.apiMethod} ${response.apiUrl}`;
                    if (response.apiResponsePath) {
                        apiInfo += `<br>å“åº”è·¯å¾„ï¼š${response.apiResponsePath}`;
                    }
                    if (response.apiResponseType && response.apiResponseType !== 'auto') {
                        apiInfo += `<br>å“åº”ç±»å‹ï¼š${response.apiResponseType === 'json' ? 'JSON' : 'çº¯æ–‡æœ¬'}`;
                    }
                    return apiInfo;
                case 'pythonRemote':
                    return `Pythonè¿œç¨‹æ‰§è¡Œï¼š${response.remoteUrl}<br><pre class="p-2 mt-2 overflow-x-auto text-sm bg-gray-100 rounded">${response.remoteCode}</pre>`;
                case 'nodeRemote':
                    return `Nodeè¿œç¨‹æ‰§è¡Œï¼š${response.remoteUrl}<br><pre class="p-2 mt-2 overflow-x-auto text-sm bg-gray-100 rounded">${response.remoteCode}</pre>`;
                default:
                    return 'æœªçŸ¥ç±»å‹';
            }
        }
        
        // åˆ é™¤è§„åˆ™
        async function deleteRule(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è§„åˆ™å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/rules/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showStatus('è§„åˆ™åˆ é™¤æˆåŠŸ');
                    loadRules();
                } else {
                    const error = await response.text();
                    showStatus('åˆ é™¤å¤±è´¥ï¼š' + error, 'error');
                }
            } catch (error) {
                showStatus('åˆ é™¤å¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
        // æ·»åŠ æ–°è§„åˆ™
        function addNewRule() {
            // é‡ç½®è¡¨å•
            document.getElementById('edit-rule-form').reset();
            document.getElementById('edit-rule-id').value = '';
            
            // è®¾ç½®é»˜è®¤å€¼
            document.getElementById('edit-response-type').value = 'text';
            document.getElementById('edit-enabled').value = 'true';
            
            // æ›´æ–°å“åº”å­—æ®µ
            updateEditResponseFields();
            
            // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜
            document.querySelector('#edit-modal .bg-gradient-to-r h3').textContent = 'â• æ·»åŠ æ¶ˆæ¯è§„åˆ™';
            document.querySelector('#edit-modal button[type="submit"]').textContent = 'ğŸ’¾ æ·»åŠ è§„åˆ™';
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            showEditModal();
        }
        
        // ç¼–è¾‘è§„åˆ™
        async function editRule(id) {
            try {
                const response = await fetch(`/api/rules/${id}`);
                if (!response.ok) {
                    throw new Error('è·å–è§„åˆ™å¤±è´¥');
                }
                
                const rule = await response.json();
                
                // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜ä¸ºç¼–è¾‘æ¨¡å¼
                document.querySelector('#edit-modal .bg-gradient-to-r h3').textContent = 'ğŸ“ ç¼–è¾‘æ¶ˆæ¯è§„åˆ™';
                document.querySelector('#edit-modal button[type="submit"]').textContent = 'ğŸ’¾ ä¿å­˜æ›´æ”¹';
                
                populateEditForm(rule);
                showEditModal();
                
            } catch (error) {
                showStatus('è·å–è§„åˆ™å¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
        // å¡«å……ç¼–è¾‘è¡¨å•
        function populateEditForm(rule) {
            document.getElementById('edit-rule-id').value = rule.id;
            document.getElementById('edit-description').value = rule.description || '';
            document.getElementById('edit-trigger-type').value = rule.trigger.type;
            document.getElementById('edit-keyword').value = rule.trigger.keyword;
            document.getElementById('edit-response-type').value = rule.response.type;
            document.getElementById('edit-enabled').value = rule.enabled.toString();
            
            // æ›´æ–°å“åº”å­—æ®µæ˜¾ç¤º
            updateEditResponseFields();
            
            // æ ¹æ®å“åº”ç±»å‹å¡«å……ç›¸åº”çš„å­—æ®µ
            populateEditResponseFields(rule.response);
        }
        
        // æ›´æ–°ç¼–è¾‘æ¨¡å¼çš„å“åº”å­—æ®µ
        function updateEditResponseFields() {
            const responseType = document.getElementById('edit-response-type').value;
            const fieldsContainer = document.getElementById('edit-response-fields');
            
            let fieldsHTML = '';
            const inputClass = "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent";
            
            switch (responseType) {
                case 'text':
                    fieldsHTML = `
                        <div>
                            <label for="edit-response-text" class="block mb-2 text-sm font-medium text-gray-700">å›å¤æ–‡å­—</label>
                            <textarea id="edit-response-text" name="responseText" rows="4" 
                                      class="${inputClass}" placeholder="è¾“å…¥è¦å›å¤çš„æ–‡å­—å†…å®¹"></textarea>
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center">
                                <input type="checkbox" id="abort-xiao-ai-enabled" name="abortXiaoAI" class="mr-2">
                                <label for="abort-xiao-ai-enabled" class="text-sm font-medium text-blue-700">æ‰“æ–­å°çˆ±å›å¤</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="play-blocking-enabled" name="playBlocking" class="mr-2" checked>
                                <label for="play-blocking-enabled" class="text-sm font-medium text-gray-700">é˜»å¡æ’­æ”¾</label>
                            </div>
                            <p class="text-xs text-gray-500">å¯ç”¨"æ‰“æ–­å°çˆ±å›å¤"åï¼Œå¯é€‰æ‹©æ˜¯å¦ç­‰å¾…æ’­æ”¾å®Œæ¯•</p>
                        </div>
                    `;
                    break;
                case 'audio':
                    fieldsHTML = `
                        <div>
                            <label for="edit-audio-url" class="block mb-2 text-sm font-medium text-gray-700">éŸ³é¢‘é“¾æ¥</label>
                            <input type="url" id="edit-audio-url" name="audioUrl" class="${inputClass}" 
                                   placeholder="https://example.com/audio.mp3">
                        </div>
                        <div>
                            <label for="edit-audio-text" class="block mb-2 text-sm font-medium text-gray-700">æ’­æ”¾å‰çš„æ–‡å­—ï¼ˆå¯é€‰ï¼‰</label>
                            <input type="text" id="edit-audio-text" name="audioText" class="${inputClass}" 
                                   placeholder="å³å°†æ’­æ”¾éŸ³é¢‘">
                        </div>
                    `;
                    break;
                case 'builtInCommand':
                    fieldsHTML = `
                        <div>
                            <label for="edit-built-in-command" class="block mb-2 text-sm font-medium text-gray-700">å†…ç½®æŒ‡ä»¤</label>
                            <input type="text" id="edit-built-in-command" name="builtInCommand" class="${inputClass}" 
                                   placeholder="å¼€ç¯">
                            <p class="mt-1 text-sm text-gray-500">å°çˆ±éŸ³ç®±å°†æ‰§è¡Œæ­¤å†…ç½®æŒ‡ä»¤</p>
                        </div>
                    `;
                    break;
                case 'localCode':
                    fieldsHTML = `
                        <div>
                            <label for="edit-local-code" class="block mb-2 text-sm font-medium text-gray-700">JavaScript ä»£ç </label>
                            <textarea id="edit-local-code" name="localCode" rows="6" class="${inputClass}" 
                                      placeholder="await engine.speaker.abortXiaoAI();"></textarea>
                            <p class="mt-1 text-sm text-red-600">âš ï¸ æœ¬åœ°ä»£ç æ‹¥æœ‰å®Œæ•´ç³»ç»Ÿæƒé™ï¼Œè¯·è°¨æ…ä½¿ç”¨</p>
                            <p class="text-sm text-yellow-800">
                                <strong>DEMO: </strong>
                                <br> await engine.speaker.abortXiaoAI();
                                <br> await sleep(2000); // æ‰“æ–­å°çˆ±åéœ€è¦ç­‰å¾… 2 ç§’ï¼Œä½¿å…¶æ¢å¤è¿è¡Œåæ‰èƒ½ç»§ç»­ TTS
                                <br> await engine.speaker.play({ text: "ä½ å¥½ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ï¼", blocking: true }); // æ’­æ”¾æ–‡å­—
                                <br> await engine.speaker.play({ url: "https://example.com/hello.mp3" }); // æ’­æ”¾éŸ³é¢‘é“¾æ¥ 
                                <br> return { handled: true };</code>  // å‘Šè¯‰ MiGPT å·²ç»å¤„ç†è¿‡è¿™æ¡æ¶ˆæ¯äº†ï¼Œä¸å†ä½¿ç”¨é»˜è®¤çš„ AI å›å¤
                            </p>
                        </div>
                    `;
                    break;
                case 'sandboxCode':
                    fieldsHTML = `
                        <div>
                            <label for="edit-sandbox-code" class="block mb-2 text-sm font-medium text-gray-700">JavaScript ä»£ç ï¼ˆæ²™ç›’ç¯å¢ƒï¼‰</label>
                            <textarea id="edit-sandbox-code" name="sandboxCode" rows="6" class="${inputClass}" 
                                      placeholder="console.log('Hello');"></textarea>
                            <p class="mt-1 text-sm text-blue-600">ğŸ”’ æ²™ç›’ç¯å¢ƒæ›´å®‰å…¨ä½†åŠŸèƒ½å—é™</p>
                        </div>
                    `;
                    break;
                case 'terminalCommand':
                    fieldsHTML = `
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label for="edit-terminal-command" class="block mb-2 text-sm font-medium text-gray-700">ç»ˆç«¯å‘½ä»¤</label>
                                <textarea id="edit-terminal-command" name="terminalCommand" rows="3" class="${inputClass}" 
                                          placeholder="ls -la&#10;echo 'Hello World'&#10;cat /etc/passwd" required></textarea>
                                <p class="mt-1 text-sm text-gray-500">æ”¯æŒå¤šè¡Œå‘½ä»¤ï¼Œæ¯è¡Œä¸€ä¸ªå‘½ä»¤</p>
                            </div>
                        </div>
                        
                        <!-- SSHé…ç½® -->
                        <div class="p-4 border border-gray-200 rounded-lg bg-blue-50">
                            <div class="flex items-center mb-3">
                                <input type="checkbox" id="edit-ssh-enabled" name="sshEnabled" class="mr-2" onchange="toggleSshFields()">
                                <label for="edit-ssh-enabled" class="text-sm font-medium text-blue-700">ğŸ” å¯ç”¨SSHè¿œç¨‹æ‰§è¡Œ</label>
                            </div>
                            <div id="ssh-fields" class="hidden space-y-4">
                                <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                                    <div>
                                        <label for="edit-ssh-host" class="block mb-2 text-sm font-medium text-gray-700">SSHä¸»æœº</label>
                                        <input type="text" id="edit-ssh-host" name="sshHost" class="${inputClass}" 
                                               placeholder="192.168.1.100 æˆ– example.com">
                                    </div>
                                    <div>
                                        <label for="edit-ssh-port" class="block mb-2 text-sm font-medium text-gray-700">SSHç«¯å£</label>
                                        <input type="number" id="edit-ssh-port" name="sshPort" class="${inputClass}" 
                                               value="22" min="1" max="65535">
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                                    <div>
                                        <label for="edit-ssh-username" class="block mb-2 text-sm font-medium text-gray-700">SSHç”¨æˆ·å</label>
                                        <input type="text" id="edit-ssh-username" name="sshUsername" class="${inputClass}" 
                                               placeholder="root æˆ– ubuntu">
                                    </div>
                                    <div>
                                        <label for="edit-ssh-auth-method" class="block mb-2 text-sm font-medium text-gray-700">è®¤è¯æ–¹å¼</label>
                                        <select id="edit-ssh-auth-method" name="sshAuthMethod" class="${inputClass}" onchange="toggleAuthFields()">
                                            <option value="key">å¯†é’¥è®¤è¯</option>
                                            <option value="password">å¯†ç è®¤è¯</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="ssh-auth-fields">
                                    <!-- å¯†é’¥è®¤è¯å­—æ®µ -->
                                    <div id="ssh-key-fields" class="space-y-4">
                                        <div>
                                            <label for="edit-ssh-private-key-path" class="block mb-2 text-sm font-medium text-gray-700">ç§é’¥æ–‡ä»¶è·¯å¾„</label>
                                            <input type="text" id="edit-ssh-private-key-path" name="sshPrivateKeyPath" class="${inputClass}" 
                                                   placeholder="~/.ssh/id_rsa æˆ– /path/to/private_key">
                                            <p class="mt-1 text-sm text-gray-500">æ”¯æŒç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„</p>
                                        </div>
                                        <div>
                                            <label for="edit-ssh-passphrase" class="block mb-2 text-sm font-medium text-gray-700">ç§é’¥å¯†ç çŸ­è¯­ï¼ˆå¯é€‰ï¼‰</label>
                                            <input type="password" id="edit-ssh-passphrase" name="sshPassphrase" class="${inputClass}" 
                                                   placeholder="å¦‚æœç§é’¥æœ‰å¯†ç ä¿æŠ¤ï¼Œè¯·è¾“å…¥">
                                        </div>
                                    </div>
                                    <!-- å¯†ç è®¤è¯å­—æ®µ -->
                                    <div id="ssh-password-fields" class="hidden space-y-4">
                                        <div>
                                            <label for="edit-ssh-password" class="block mb-2 text-sm font-medium text-gray-700">SSHå¯†ç </label>
                                            <input type="password" id="edit-ssh-password" name="sshPassword" class="${inputClass}" 
                                                   placeholder="è¾“å…¥SSHç™»å½•å¯†ç ">
                                            <p class="mt-1 text-sm text-red-600">âš ï¸ å¯†ç å°†æ˜æ–‡å­˜å‚¨ï¼Œå»ºè®®ä½¿ç”¨å¯†é’¥è®¤è¯</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                            <div>
                                <label for="edit-terminal-working-dir" class="block mb-2 text-sm font-medium text-gray-700">å·¥ä½œç›®å½•ï¼ˆå¯é€‰ï¼‰</label>
                                <input type="text" id="edit-terminal-working-dir" name="terminalWorkingDir" class="${inputClass}" 
                                       placeholder="/path/to/directory">
                            </div>
                            <div>
                                <label for="edit-terminal-return-output" class="block mb-2 text-sm font-medium text-gray-700">è¿”å›è¾“å‡º</label>
                                <select id="edit-terminal-return-output" name="terminalReturnOutput" class="${inputClass}">
                                    <option value="true">æ˜¯ - è¿”å›å‘½ä»¤è¾“å‡º</option>
                                    <option value="false">å¦ - ä»…ç¡®è®¤æ‰§è¡Œ</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                            <div>
                                <label for="edit-terminal-timeout" class="block mb-2 text-sm font-medium text-gray-700">è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</label>
                                <input type="number" id="edit-terminal-timeout" name="terminalTimeout" class="${inputClass}" 
                                       value="30" min="1" max="300">
                            </div>
                        </div>
                        <div class="p-3 mt-4 border border-yellow-200 rounded-lg bg-yellow-50">
                            <p class="text-sm text-yellow-800">
                                <strong>âš ï¸ å®‰å…¨æç¤ºï¼š</strong>
                                <br>â€¢ æœ¬åœ°æ‰§è¡Œï¼šå‘½ä»¤å°†åœ¨æœ¬åœ°ç³»ç»Ÿæ‰§è¡Œï¼Œå…·æœ‰å®Œæ•´æƒé™
                                <br>â€¢ SSHæ‰§è¡Œï¼šå‘½ä»¤å°†åœ¨è¿œç¨‹æœåŠ¡å™¨æ‰§è¡Œï¼Œè¯·ç¡®ä¿æœåŠ¡å™¨å®‰å…¨
                                <br>â€¢ å»ºè®®ä½¿ç”¨å¯†é’¥è®¤è¯è€Œéå¯†ç è®¤è¯
                                <br>â€¢ é¿å…æ‰§è¡Œå±é™©å‘½ä»¤å¦‚ rm -rf ç­‰
                            </p>
                        </div>
                    `;
                    break;
                case 'apiCall':
                    fieldsHTML = `
                        <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
                            <div>
                                <label for="edit-api-method" class="block mb-2 text-sm font-medium text-gray-700">è¯·æ±‚æ–¹æ³•</label>
                                <select id="edit-api-method" name="apiMethod" class="${inputClass}">
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                    <option value="PUT">PUT</option>
                                    <option value="DELETE">DELETE</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label for="edit-api-url" class="block mb-2 text-sm font-medium text-gray-700">APIåœ°å€</label>
                                <input type="url" id="edit-api-url" name="apiUrl" class="${inputClass}" 
                                       placeholder="https://api.example.com/endpoint">
                            </div>
                        </div>
                        <div>
                            <label for="edit-api-headers" class="block mb-2 text-sm font-medium text-gray-700">è¯·æ±‚å¤´ï¼ˆJSONæ ¼å¼ï¼Œå¯é€‰ï¼‰</label>
                            <textarea id="edit-api-headers" name="apiHeaders" rows="3" class="${inputClass}" 
                                      placeholder='{"Authorization": "Bearer token"}'></textarea>
                        </div>
                        <div>
                            <label for="edit-api-body" class="block mb-2 text-sm font-medium text-gray-700">è¯·æ±‚ä½“ï¼ˆJSONæ ¼å¼ï¼Œä»…POST/PUTï¼‰</label>
                            <textarea id="edit-api-body" name="apiBody" rows="3" class="${inputClass}" 
                                      placeholder='{"key": "value"}'></textarea>
                        </div>
                        <div class="p-4 mt-4 rounded-lg bg-gray-50">
                            <h4 class="mb-3 text-sm font-medium text-gray-700">å“åº”è§£æé…ç½®</h4>
                            <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                                <div>
                                    <label for="edit-api-response-type" class="block mb-2 text-sm font-medium text-gray-700">å“åº”æ•°æ®ç±»å‹</label>
                                    <select id="edit-api-response-type" name="apiResponseType" class="${inputClass}">
                                        <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
                                        <option value="json">JSON</option>
                                        <option value="text">çº¯æ–‡æœ¬</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="edit-api-response-path" class="block mb-2 text-sm font-medium text-gray-700">JSONè·¯å¾„ï¼ˆå¯é€‰ï¼‰</label>
                                    <input type="text" id="edit-api-response-path" name="apiResponsePath" class="${inputClass}" 
                                           placeholder="data.text æˆ– message">
                                </div>
                            </div>
                            <div class="mt-3">
                                <label for="edit-api-response-fallback" class="block mb-2 text-sm font-medium text-gray-700">è§£æå¤±è´¥æ—¶çš„é»˜è®¤æ–‡æœ¬</label>
                                <input type="text" id="edit-api-response-fallback" name="apiResponseFallback" class="${inputClass}" 
                                       placeholder="APIè°ƒç”¨æˆåŠŸï¼Œä½†å“åº”è§£æå¤±è´¥">
                            </div>
                            <p class="mt-2 text-xs text-gray-500">
                                ğŸ’¡ JSONè·¯å¾„ç¤ºä¾‹ï¼š<code>data.text</code>ã€<code>message</code>ã€<code>result.content</code>
                            </p>
                        </div>
                    `;
                    break;
                case 'pythonRemote':
                    fieldsHTML = `
                        <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
                            <div class="md:col-span-2">
                                <label for="edit-python-url" class="block mb-2 text-sm font-medium text-gray-700">è¿œç¨‹æ‰§è¡ŒæœåŠ¡åœ°å€</label>
                                <input type="url" id="edit-python-url" name="pythonUrl" class="${inputClass}" 
                                       placeholder="https://your-python-executor.com/execute">
                            </div>
                            <div>
                                <label for="edit-python-timeout" class="block mb-2 text-sm font-medium text-gray-700">è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</label>
                                <input type="number" id="edit-python-timeout" name="pythonTimeout" class="${inputClass}" 
                                       value="30" min="1" max="300">
                            </div>
                        </div>
                        <div>
                            <label for="edit-python-code" class="block mb-2 text-sm font-medium text-gray-700">Python ä»£ç </label>
                            <textarea id="edit-python-code" name="pythonCode" rows="6" class="${inputClass}" 
                                      placeholder="print('Hello Python')"></textarea>
                        </div>
                    `;
                    break;
                case 'nodeRemote':
                    fieldsHTML = `
                        <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
                            <div class="md:col-span-2">
                                <label for="edit-node-url" class="block mb-2 text-sm font-medium text-gray-700">è¿œç¨‹æ‰§è¡ŒæœåŠ¡åœ°å€</label>
                                <input type="url" id="edit-node-url" name="nodeUrl" class="${inputClass}" 
                                       placeholder="https://your-node-executor.com/execute">
                            </div>
                            <div>
                                <label for="edit-node-timeout" class="block mb-2 text-sm font-medium text-gray-700">è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</label>
                                <input type="number" id="edit-node-timeout" name="nodeTimeout" class="${inputClass}" 
                                       value="30" min="1" max="300">
                            </div>
                        </div>
                        <div>
                            <label for="edit-node-code" class="block mb-2 text-sm font-medium text-gray-700">Node.js ä»£ç </label>
                            <textarea id="edit-node-code" name="nodeCode" rows="6" class="${inputClass}" 
                                      placeholder="console.log('Hello Node');"></textarea>
                        </div>
                    `;
                    break;
            }
            
            fieldsContainer.innerHTML = fieldsHTML;
        }
        
        // å¡«å……ç¼–è¾‘å“åº”å­—æ®µ
        function populateEditResponseFields(response) {
            setTimeout(() => {
                switch (response.type) {
                    case 'text':
                        const textField = document.getElementById('edit-response-text');
                        const abortXiaoAIField = document.getElementById('abort-xiao-ai-enabled');
                        const playBlockingField = document.getElementById('play-blocking-enabled');

                        if (abortXiaoAIField) abortXiaoAIField.checked = response.abortXiaoAI || false;
                        if (playBlockingField) playBlockingField.checked = response.playBlocking !== false; // é»˜è®¤ä¸ºtrue
                        if (textField) textField.value = response.text || '';
                        break;
                    case 'audio':
                        const audioUrlField = document.getElementById('edit-audio-url');
                        const audioTextField = document.getElementById('edit-audio-text');
                        if (audioUrlField) audioUrlField.value = response.audioUrl || '';
                        if (audioTextField) audioTextField.value = response.audioText || '';
                        break;
                    case 'builtInCommand':
                        const builtInCommandField = document.getElementById('edit-built-in-command');
                        if (builtInCommandField) builtInCommandField.value = response.builtInCommand || '';
                        break;
                    case 'localCode':
                        const localCodeField = document.getElementById('edit-local-code');
                        if (localCodeField) localCodeField.value = response.localCode || '';
                        break;
                    case 'sandboxCode':
                        const sandboxCodeField = document.getElementById('edit-sandbox-code');
                        if (sandboxCodeField) sandboxCodeField.value = response.sandboxCode || '';
                        break;
                    case 'terminalCommand':
                        const terminalCommandField = document.getElementById('edit-terminal-command');
                        const terminalWorkingDirField = document.getElementById('edit-terminal-working-dir');
                        const terminalTimeoutField = document.getElementById('edit-terminal-timeout');
                        const terminalReturnOutputField = document.getElementById('edit-terminal-return-output');
                        
                        // åŸºç¡€å­—æ®µ
                        if (terminalCommandField) terminalCommandField.value = response.terminalCommand || '';
                        if (terminalWorkingDirField) terminalWorkingDirField.value = response.terminalWorkingDir || '';
                        if (terminalTimeoutField) terminalTimeoutField.value = response.terminalTimeout || 30;
                        if (terminalReturnOutputField) terminalReturnOutputField.value = (response.terminalReturnOutput !== false).toString();
                        
                        // SSHé…ç½®å­—æ®µ
                        const sshEnabledField = document.getElementById('edit-ssh-enabled');
                        const sshHostField = document.getElementById('edit-ssh-host');
                        const sshPortField = document.getElementById('edit-ssh-port');
                        const sshUsernameField = document.getElementById('edit-ssh-username');
                        const sshAuthMethodField = document.getElementById('edit-ssh-auth-method');
                        const sshPrivateKeyPathField = document.getElementById('edit-ssh-private-key-path');
                        const sshPassphraseField = document.getElementById('edit-ssh-passphrase');
                        const sshPasswordField = document.getElementById('edit-ssh-password');
                        
                        if (response.ssh) {
                            if (sshEnabledField) {
                                sshEnabledField.checked = true;
                                toggleSshFields(); // æ˜¾ç¤ºSSHå­—æ®µ
                            }
                            if (sshHostField) sshHostField.value = response.ssh.host || '';
                            if (sshPortField) sshPortField.value = response.ssh.port || 22;
                            if (sshUsernameField) sshUsernameField.value = response.ssh.username || '';
                            if (sshAuthMethodField) {
                                sshAuthMethodField.value = response.ssh.authMethod || 'key';
                                toggleAuthFields(); // æ˜¾ç¤ºå¯¹åº”çš„è®¤è¯å­—æ®µ
                            }
                            if (sshPrivateKeyPathField) sshPrivateKeyPathField.value = response.ssh.privateKeyPath || '';
                            if (sshPassphraseField) sshPassphraseField.value = response.ssh.passphrase || '';
                            if (sshPasswordField) sshPasswordField.value = response.ssh.password || '';
                        } else {
                            if (sshEnabledField) {
                                sshEnabledField.checked = false;
                                toggleSshFields(); // éšè—SSHå­—æ®µ
                            }
                        }
                        break;
                    case 'apiCall':
                        const apiMethodField = document.getElementById('edit-api-method');
                        const apiUrlField = document.getElementById('edit-api-url');
                        const apiHeadersField = document.getElementById('edit-api-headers');
                        const apiBodyField = document.getElementById('edit-api-body');
                        const apiResponseTypeField = document.getElementById('edit-api-response-type');
                        const apiResponsePathField = document.getElementById('edit-api-response-path');
                        const apiResponseFallbackField = document.getElementById('edit-api-response-fallback');
                        
                        if (apiMethodField) apiMethodField.value = response.apiMethod || 'GET';
                        if (apiUrlField) apiUrlField.value = response.apiUrl || '';
                        if (apiHeadersField) apiHeadersField.value = response.apiHeaders ? JSON.stringify(response.apiHeaders, null, 2) : '';
                        if (apiBodyField) apiBodyField.value = response.apiBody || '';
                        if (apiResponseTypeField) apiResponseTypeField.value = response.apiResponseType || 'auto';
                        if (apiResponsePathField) apiResponsePathField.value = response.apiResponsePath || '';
                        if (apiResponseFallbackField) apiResponseFallbackField.value = response.apiResponseFallback || '';
                        break;
                    case 'pythonRemote':
                        const pythonUrlField = document.getElementById('edit-python-url');
                        const pythonCodeField = document.getElementById('edit-python-code');
                        const pythonTimeoutField = document.getElementById('edit-python-timeout');
                        if (pythonUrlField) pythonUrlField.value = response.remoteUrl || '';
                        if (pythonCodeField) pythonCodeField.value = response.remoteCode || '';
                        if (pythonTimeoutField) pythonTimeoutField.value = response.remoteTimeout || 30;
                        break;
                    case 'nodeRemote':
                        const nodeUrlField = document.getElementById('edit-node-url');
                        const nodeCodeField = document.getElementById('edit-node-code');
                        const nodeTimeoutField = document.getElementById('edit-node-timeout');
                        if (nodeUrlField) nodeUrlField.value = response.remoteUrl || '';
                        if (nodeCodeField) nodeCodeField.value = response.remoteCode || '';
                        if (nodeTimeoutField) nodeTimeoutField.value = response.remoteTimeout || 30;
                        break;
                }
            }, 100);
        }
        
        // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
        function showEditModal() {
            document.getElementById('edit-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        
        // åŠ è½½å…¨å±€è®¾ç½®
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();
                
                document.getElementById('call-keywords').value = settings.callAIKeywords?.join(',') || '';
                document.getElementById('system-prompt').value = settings.systemPrompt || '';
                document.getElementById('history-max-length').value = settings.historyMaxLength || 10;
                
                document.getElementById('openai-api-key').value = settings.openai?.apiKey || '';
                document.getElementById('openai-base-url').value = settings.openai?.baseUrl || 'https://api.openai.com/v1';
                document.getElementById('openai-model').value = settings.openai?.model || 'gpt-3.5-turbo';
                
            } catch (error) {
                showStatus('åŠ è½½è®¾ç½®å¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
        // ç¼–è¾‘è§„åˆ™è¡¨å•æäº¤
        document.getElementById('edit-rule-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const ruleId = formData.get('ruleId');
            
            // æ„å»ºè§„åˆ™ç»“æ„
            const rule = {
                trigger: {
                    type: formData.get('triggerType'),
                    keyword: formData.get('keyword')
                },
                response: {
                    type: formData.get('responseType')
                },
                enabled: formData.get('enabled') === 'true',
                description: formData.get('description')
            };
            
            // æ ¹æ®å“åº”ç±»å‹æ·»åŠ å¯¹åº”å­—æ®µ
            const responseType = rule.response.type;
            switch (responseType) {
                case 'text':
                    rule.response.text = formData.get('responseText');
                    rule.response.abortXiaoAI = formData.get('abortXiaoAI') === 'on';
                    rule.response.playBlocking = formData.get('playBlocking') === 'on';
                    break;
                case 'audio':
                    rule.response.audioUrl = formData.get('audioUrl');
                    rule.response.audioText = formData.get('audioText');
                    break;
                case 'builtInCommand':
                    rule.response.builtInCommand = formData.get('builtInCommand');
                    break;
                case 'localCode':
                    rule.response.localCode = formData.get('localCode');
                    break;
                case 'sandboxCode':
                    rule.response.sandboxCode = formData.get('sandboxCode');
                    break;
                case 'terminalCommand':
                    rule.response.terminalCommand = formData.get('terminalCommand');
                    rule.response.terminalWorkingDir = formData.get('terminalWorkingDir');
                    rule.response.terminalTimeout = parseInt(formData.get('terminalTimeout')) || 30;
                    rule.response.terminalReturnOutput = formData.get('terminalReturnOutput') === 'true';
                    
                    // SSHé…ç½®å¤„ç†
                    if (formData.get('sshEnabled') === 'on') {
                        rule.response.ssh = {
                            host: formData.get('sshHost'),
                            port: parseInt(formData.get('sshPort')) || 22,
                            username: formData.get('sshUsername'),
                            authMethod: formData.get('sshAuthMethod') || 'key'
                        };
                        
                        if (rule.response.ssh.authMethod === 'key') {
                            rule.response.ssh.privateKeyPath = formData.get('sshPrivateKeyPath');
                            rule.response.ssh.passphrase = formData.get('sshPassphrase');
                        } else {
                            rule.response.ssh.password = formData.get('sshPassword');
                        }
                        
                        // éªŒè¯SSHå¿…å¡«å­—æ®µ
                        if (!rule.response.ssh.host || !rule.response.ssh.username) {
                            return showStatus('SSHé…ç½®ä¸å®Œæ•´ï¼šè¯·å¡«å†™ä¸»æœºå’Œç”¨æˆ·å', 'error');
                        }
                        
                        if (rule.response.ssh.authMethod === 'key' && !rule.response.ssh.privateKeyPath) {
                            return showStatus('SSHé…ç½®ä¸å®Œæ•´ï¼šè¯·å¡«å†™ç§é’¥æ–‡ä»¶è·¯å¾„', 'error');
                        }
                        
                        if (rule.response.ssh.authMethod === 'password' && !rule.response.ssh.password) {
                            return showStatus('SSHé…ç½®ä¸å®Œæ•´ï¼šè¯·å¡«å†™å¯†ç ', 'error');
                        }
                    }
                    break;
                case 'apiCall':
                    rule.response.apiUrl = formData.get('apiUrl');
                    rule.response.apiMethod = formData.get('apiMethod');
                    const headersText = formData.get('apiHeaders');
                    if (headersText) {
                        try {
                            rule.response.apiHeaders = JSON.parse(headersText);
                        } catch (e) {
                            return showStatus('APIè¯·æ±‚å¤´æ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨æœ‰æ•ˆçš„JSONæ ¼å¼', 'error');
                        }
                    }
                    rule.response.apiBody = formData.get('apiBody');
                    rule.response.apiResponseType = formData.get('apiResponseType');
                    rule.response.apiResponsePath = formData.get('apiResponsePath');
                    rule.response.apiResponseFallback = formData.get('apiResponseFallback');
                    break;
                case 'pythonRemote':
                    rule.response.remoteUrl = formData.get('pythonUrl');
                    rule.response.remoteCode = formData.get('pythonCode');
                    rule.response.remoteTimeout = parseInt(formData.get('pythonTimeout'));
                    break;
                case 'nodeRemote':
                    rule.response.remoteUrl = formData.get('nodeUrl');
                    rule.response.remoteCode = formData.get('nodeCode');
                    rule.response.remoteTimeout = parseInt(formData.get('nodeTimeout'));
                    break;
            }
            
            try {
                let response, successMessage;
                
                if (ruleId) {
                    // ç¼–è¾‘ç°æœ‰è§„åˆ™
                    response = await fetch(`/api/rules/${ruleId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(rule)
                    });
                    successMessage = 'è§„åˆ™æ›´æ–°æˆåŠŸ';
                } else {
                    // æ·»åŠ æ–°è§„åˆ™
                    response = await fetch('/api/rules', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(rule)
                    });
                    successMessage = 'è§„åˆ™æ·»åŠ æˆåŠŸ';
                }
                
                if (response.ok) {
                    showStatus(successMessage);
                    closeEditModal();
                    loadRules(); // åˆ·æ–°è§„åˆ™åˆ—è¡¨
                } else {
                    const error = await response.text();
                    showStatus(`æ“ä½œå¤±è´¥ï¼š${error}`, 'error');
                }
            } catch (error) {
                showStatus(`æ“ä½œå¤±è´¥ï¼š${error.message}`, 'error');
            }
        });
        
        // è®¾ç½®è¡¨å•æäº¤
        document.getElementById('settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const settings = {
                callAIKeywords: formData.get('callKeywords').split(',').map(k => k.trim()).filter(k => k),
                systemPrompt: formData.get('systemPrompt'),
                historyMaxLength: parseInt(formData.get('historyMaxLength'))
            };
            
            // OpenAI è®¾ç½®
            const openaiSettings = {};
            
            // API Key - å¦‚æœä¸ä¸ºç©ºæ‰æ·»åŠ åˆ°è®¾ç½®ä¸­
            const apiKey = formData.get('openaiApiKey');
            if (apiKey && apiKey.trim() !== '') {
                openaiSettings.apiKey = apiKey.trim();
            }
            
            // å…¶ä»– OpenAI è®¾ç½®
            const baseUrl = formData.get('openaiBaseUrl');
            if (baseUrl && baseUrl.trim() !== '') {
                openaiSettings.baseUrl = baseUrl.trim();
            }
            
            openaiSettings.model = formData.get('openaiModel') || 'gpt-3.5-turbo';
            
            // åªæœ‰å½“æœ‰ OpenAI è®¾ç½®æ—¶æ‰æ·»åŠ åˆ°ä¸»è®¾ç½®å¯¹è±¡
            if (Object.keys(openaiSettings).length > 0) {
                settings.openai = openaiSettings;
            }
            
            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                
                if (response.ok) {
                    showStatus('è®¾ç½®ä¿å­˜æˆåŠŸ');
                    // é‡æ–°åŠ è½½è®¾ç½®ä»¥æ›´æ–° API Key çš„æ˜¾ç¤º
                    loadSettings();
                } else {
                    const error = await response.text();
                    showStatus('ä¿å­˜å¤±è´¥ï¼š' + error, 'error');
                }
            } catch (error) {
                showStatus('ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½è§„åˆ™
        document.addEventListener('DOMContentLoaded', () => {
            loadRules();
            
            // æ¨¡æ€æ¡†å¤–éƒ¨ç‚¹å‡»å…³é—­
            document.getElementById('edit-modal').addEventListener('click', (e) => {
                if (e.target.id === 'edit-modal') {
                    closeEditModal();
                }
            });
            
            // ESCé”®å…³é—­æ¨¡æ€æ¡†
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeEditModal();
                }
            });
        });
        
        // åˆ‡æ¢SSHå­—æ®µæ˜¾ç¤º/éšè—
        function toggleSshFields() {
            const sshEnabled = document.getElementById('edit-ssh-enabled')?.checked || false;
            const sshFields = document.getElementById('ssh-fields');
            
            if (sshFields) {
                if (sshEnabled) {
                    sshFields.classList.remove('hidden');
                } else {
                    sshFields.classList.add('hidden');
                }
            }
        }
        
        // åˆ‡æ¢SSHè®¤è¯æ–¹å¼å­—æ®µ
        function toggleAuthFields() {
            const authMethod = document.getElementById('edit-ssh-auth-method')?.value;
            const keyFields = document.getElementById('ssh-key-fields');
            const passwordFields = document.getElementById('ssh-password-fields');
            
            if (keyFields && passwordFields) {
                if (authMethod === 'key') {
                    keyFields.classList.remove('hidden');
                    passwordFields.classList.add('hidden');
                } else {
                    keyFields.classList.add('hidden');
                    passwordFields.classList.remove('hidden');
                }
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // é¡µé¢åˆå§‹åŒ–å®Œæˆ
        });
    </script>
</body>
</html>
